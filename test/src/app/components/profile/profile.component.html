<div *ngIf="user$ | async as user; else loading">
  <div class="profile-container">
    <div class="profile-actions">
      <button (click)="toggleEdit()" *ngIf="!isEditing">Editar Perfil</button>
    </div>

    <!-- Viewing Mode -->
    <div *ngIf="!isEditing">
      <div class="profile-header user-card">
        <div class="avatar-wrapper">
          <img [src]="user.foto || 'assets/default-profile.png'" alt="Foto do Perfil" class="profile-picture big-avatar">
        </div>
        <div class="user-info-block">
          <h2 class="user-name">{{ user.username }}</h2>
          <p class="user-email">{{ user.email }}</p>
          <div class="user-badges">
            <span class="badge saldo">Saldo: R$ {{ user.saldo | number:'1.2-2' }}</span>
            <span class="badge nivel">NÃ­vel: {{ user.nivel }}</span>
            <span class="badge vendas">Vendas: {{ user.vendas }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Editing Mode -->
    <div *ngIf="isEditing">
      <form [formGroup]="editProfileForm" (ngSubmit)="onSave()">
        <div class="form-group">
          <label for="username">Nome de UsuÃ¡rio:</label>
          <input id="username" formControlName="username">
        </div>
        <div class="form-group">
          <label for="email">Email:</label>
          <input id="email" type="email" formControlName="email">
        </div>
        <div class="form-group">
          <label for="foto">URL da Foto:</label>
          <input id="foto" formControlName="foto">
        </div>
        <div class="form-actions">
          <button type="submit" [disabled]="editProfileForm.invalid">Salvar</button>
          <button type="button" (click)="toggleEdit()">Cancelar</button>
        </div>
      </form>
    </div>

    <div class="transaction-history">
      <h3>HistÃ³rico de TransaÃ§Ãµes</h3>

      <div class="totals-summary">
        <div class="total-box saldo">
          <h4>Saldo Atual</h4>
          <p>R$ {{ user.saldo | number:'1.2-2' }}</p>
        </div>
        <div class="total-box sales">
          <h4>Total Vendas</h4>
          <p>R$ {{ totalVendas | number:'1.2-2' }}</p>
        </div>
        <div class="total-box purchases">
          <h4>Total Compras</h4>
          <p>-R$ {{ totalCompras | number:'1.2-2' }}</p>
        </div>
      </div>

      <div class="filter-controls">
        <button (click)="applyFilter('all')" [class.active]="filterType === 'all'">Todos</button>
        <button (click)="applyFilter('compra')" [class.active]="filterType === 'compra'">Compras</button>
        <button (click)="applyFilter('venda')" [class.active]="filterType === 'venda'">Vendas</button>
      </div>


      <div *ngIf="filteredHistory.length > 0; else noHistory">
        <div class="history-list">
          <div *ngFor="let item of filteredHistory" class="history-item" [ngClass]="{
            'purchase': item.type === 'compra',
            'sale': item.type === 'venda'
          }">
            <div class="history-type">
              <span *ngIf="item.type === 'compra'" class="icon">ðŸ›’</span>
              <span *ngIf="item.type === 'venda'" class="icon">ðŸ’°</span>
              <span class="label">
                <ng-container [ngSwitch]="item.type">
                  <span *ngSwitchCase="'compra'">Compra</span>
                  <span *ngSwitchCase="'venda'">Venda</span>
                </ng-container>
              </span>
            </div>
            <div class="history-main">
              <div *ngIf="item.skinName"><b>Skin:</b> {{ item.skinName }}</div>
              <div *ngIf="item.type === 'compra'"><b>De:</b> {{ item.sellerUsername }}</div>
              <div *ngIf="item.type === 'venda'"><b>Para:</b> {{ item.buyerUsername }}</div>
            </div>
            <div class="history-value" [ngClass]="{
              'negative': item.type === 'compra',
              'positive': item.type === 'venda'
            }">
              <ng-container [ngSwitch]="item.type">
                <span *ngSwitchCase="'compra'">-R$ {{ item.price | number:'1.2-2' }}</span>
                <span *ngSwitchCase="'venda'">R$ {{ item.price | number:'1.2-2' }}</span>
              </ng-container>
            </div>
            <div class="history-date">
              <b>Data:</b> {{ item.date | date:'dd/MM/yyyy HH:mm' }}
            </div>
          </div>
        </div>
      </div>
      <ng-template #noHistory>
        <p>Nenhuma transaÃ§Ã£o encontrada.</p>
      </ng-template>
    </div>
  </div>
</div>

<ng-template #loading>
  <p>Carregando perfil...</p>
</ng-template>
